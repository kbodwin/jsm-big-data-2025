---
title: "Hands-on practice: Analysis with PUMS Data"
editor: source
---

## Exercise 1: Reading Partitioned PUMS Data

::: panel-tabset
### Problems

* Load the PUMS person data as an arrow dataset
* What are the dimensions of the dataset? Number of rows? Number of columns?
* Examine the dataset:
  * What columns does the dataset have?
  * What are the column types?

### Hints

You can use `arrow::open_dataset(...)` to open a dataset. Treat the dataset like it's a data frame, can you use the same functions that you are already familiar with?

### Solution

```{r}
#| eval: false
library(arrow)
library(dplyr)

# Open the PUMS dataset
pums_ds <- open_dataset("~/PUMS/data/person")

# dimensions
nrow(pums_ds)
ncol(pums_ds)

# Examine the dataset
pums_ds

# Examine schema
schema(pums_ds)
```
:::

## Exercise 2: Basic Filtering and Aggregation

::: panel-tabset
### Problems

* What was the population of California in 2018?

### Solution

```{r}
#| eval: false
library(arrow)
library(dplyr)

# Open the PUMS dataset
pums_ds <- open_dataset("~/PUMS/data/person")


result <- pums_ds |>
  filter(year == 2018, location == "ca") |>
  summarize(
    n = n(),
    population = sum(PWGTP)
  ) |>
  collect()

# View results
head(result1)
```
:::

## Exercise 2: Using DuckDB with PUMS Data

::: panel-tabset
### Problems

### Solution
```{r}
#| eval: false
library(arrow)
library(duckdb)
library(DBI)

# Open the PUMS dataset with Arrow
pums_ds <- open_dataset("data/person")

# Filter to just 2021 data for Washington
wa_2021 <- pums_ds |>
  filter(year == 2021, location == "wa") |>
  collect()

# Create DuckDB connection
con <- dbConnect(duckdb())

# Register Arrow Table with DuckDB
duckdb::duckdb_register_arrow(con, "pums_wa", wa_2021)

# Run SQL query
result <- dbGetQuery(con, "
  SELECT 
    CASE 
      WHEN AGEP < 18 THEN 'Under 18'
      WHEN AGEP < 30 THEN '18-29'
      WHEN AGEP < 45 THEN '30-44'
      WHEN AGEP < 65 THEN '45-64'
      ELSE '65+'
    END AS age_group,
    AVG(JWMNP) AS avg_commute_time,
    COUNT(*) AS n
  FROM pums_wa
  WHERE JWMNP > 0
  GROUP BY age_group
  ORDER BY age_group
")

# Disconnect when done
dbDisconnect(con, shutdown = TRUE)
```
:::

## Challenge: Formulate Your Own Analysis

- **Choose a research question:**
  - How has commute time changed over the years?
  - What's the relationship between education and income?
  - How does housing cost burden vary by state?
  - Your own question...

- **Implement the analysis using:**
  - Arrow Dataset operations
  - DuckDB SQL queries
  - Data visualization

- **Compare performance between approaches**


## The PUMS Dataset

[detailed dataset description](https://scaling-arrow-pums.s3.us-east-1.amazonaws.com/readme.html)

- **Public Use Microdata Sample**
  - US Census Bureau data
  - Individual person and household records
  - Anonymized demographic information
  - Income, education, housing, commute, etc.

- **Dataset characteristics:**
  - Multiple years (2005-2022, sans 2020)
  - All US states and territories
  - 53 Million rows (person), 25 Million rows (household)
  - 200+ variables